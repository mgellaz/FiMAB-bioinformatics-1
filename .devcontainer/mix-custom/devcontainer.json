// TODO: R is included in the conda environment (dependency of picard/gatk4), causing it to
// override the system version of R: R: /usr/local/bin/R /opt/conda/bin/R
// Furthermore, the conda version sets .libPaths() to [1] "/opt/conda/lib/R/library",
// which results in the other R packages to not be found
// they are located in"/usr/local/lib/R/site-library" "/usr/local/lib/R/library".
// It is unclear whether this is also a problem for the RStudio IDE (it might be
// launched from the non-conda version of R)/
// solutions: tweak .libPaths() / R_LIBS env var or change PATH or force remove conda r-base

// TODO: check if vscode user is recognised by RStudio Server.

// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/miniconda
{
	"name": "Unix tools, bioconda (miniforge) and R(Studio)",
	"build": {
		"context": "../..",
		"dockerfile": "../Dockerfile"
	},
	"remoteUser": "vscode",
	"features": {
		// https://github.com/rocker-org/devcontainer-features/blob/main/src/r-rig/README.md
		"ghcr.io/rocker-org/devcontainer-features/r-rig:latest": {
			"installRMarkdown": true,
			"installDevTools": true,
			"vscodeRSupport": true
		},
		// https://github.com/rocker-org/devcontainer-features/blob/main/src/rstudio-server/README.md
		"ghcr.io/rocker-org/devcontainer-features/rstudio-server": {},
		// https://github.com/rocker-org/devcontainer-features/tree/main/src/apt-packages
		"ghcr.io/rocker-org/devcontainer-features/apt-packages:1": {
			"packages": "libglpk-dev" // required for igraph
		},
		// https://github.com/rocker-org/devcontainer-features/blob/main/src/r-packages/README.md
		"ghcr.io/rocker-org/devcontainer-features/r-packages": {
			"packages": "tidyverse,rmarkdown,markdown,shiny,shinythemes,BiocManager,github::bahlolab/isoRelate,sjmisc,networkD3,igraph,RColorBrewer,viridis,vcfR,poppr,ggfortify",
			"installSystemRequirements": true
		}
	},
	"postAttachCommand": {
        "rstudio-start": "rserver"
    },
    "forwardPorts": [
        8787
    ],
    "portsAttributes": {
        "8787": {
            "label": "RStudio IDE"
        }
    },
	"customizations": {
		"vscode": {
			"settings": {
				"workbench.colorTheme": "Sonokai Maia",
				"workbench.editor.highlightModifiedTabs": true,
				"workbench.tree.renderIndentGuides": "always",
				"workbench.editor.wrapTabs": true,
				"explorer.compactFolders": false,
				"files.eol": "\n",
				"editor.wordWrap": "on",
				"editor.bracketPairColorization.enabled": true,
				"indentRainbow.lightIndicatorStyleLineWidth": 5,
				"indentRainbow.indicatorStyle": "light",
				// "terminal.integrated.scrollback": 10000,
				"editor.renderWhitespace": "trailing",
				"files.trimFinalNewlines": true,
				"files.trimTrailingWhitespace": true,
				"editor.formatOnType": true,
				"editor.formatOnSave": true,
			},
			"extensions": [
				// bash extensions
				"mads-hartmann.bash-ide-vscode",
				"foxundermoon.shell-format",
				"timonwong.shellcheck",
				// QoL
				"streetsidesoftware.code-spell-checker",
				"oderwat.indent-rainbow",
				"mechatroner.rainbow-csv",
				"ionutvmi.path-autocomplete",
				"fabiospampinato.vscode-diff",
				// R
				"REditorSupport.r",
				// general formatting
				"esbenp.prettier-vscode",
				// theming
				"sainnhe.sonokai",
				// "reageyao.biosyntax"
			]
		},
		"codespaces": {
			"openFiles": [
				"README.md"
			]
		}
	}
}
